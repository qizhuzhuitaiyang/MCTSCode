# 改进的病人信息Embedding方案

## 问题分析

原有的病人信息embedding存在以下严重问题：

### 1. 诊断编码处理缺陷
- **问题**：直接将ICD编码转float()，丢失语义信息
- **影响**：E785、V4581等含字母编码被转为0，与无诊断混淆
- **数据丢失**：大量有效诊断编码被错误处理

### 2. 手术编码处理缺陷  
- **问题**：同样直接转float()，丢失语义信息
- **影响**：02HV33Z等复杂编码被错误处理
- **数据丢失**：手术信息无法正确编码

### 3. 截断问题
- **诊断**：限制200个，但平均48.99个，部分患者可能更多
- **手术**：限制100个，但平均8.76个，相对合理
- **历史用药**：限制100个，但平均55.20个，可能截断重要信息

### 4. 特征浪费
- **问题**：112维患者特征完全未使用
- **影响**：年龄、性别、入院类型等重要信息丢失

## 改进方案

### 1. 诊断编码Embedding (64维)

#### 方法：统计特征 + 类别信息
```python
# 不再直接转float，而是提取统计特征
- 诊断数量 (归一化)
- 诊断编码分布 (均值、标准差)
- ICD类别分布 (E编码、V编码、数字编码等)
- 常见诊断类别 (基于编码前缀)
```

#### 优势：
- 保留诊断的语义信息
- 避免编码数值的误导性关联
- 提取有意义的统计特征

### 2. 手术编码Embedding (32维)

#### 方法：类似诊断编码的处理
```python
# 统计特征 + 类别信息
- 手术数量 (归一化)
- 手术编码分布
- 手术类别分布 (基于编码前缀)
```

### 3. 历史用药Embedding (64维)

#### 改进：保留更多信息 + 时间序列特征
```python
# 不再简单截断，而是提取特征
- 历史用药数量 (归一化)
- 用药多样性 (唯一药物数量)
- 用药频率分布 (最高频率、药物种类)
- 最近用药 (最后10个药物的索引)
```

#### 优势：
- 避免截断重要历史信息
- 提取用药模式特征
- 保留时间序列信息

### 4. 患者特征Embedding (352维)

#### 充分利用之前浪费的空间
```python
# 人口统计学特征
- 年龄相关 (年龄、老年标志、未成年标志)
- 性别特征 (男性、女性)
- 入院类型 (急诊、择期、紧急)
- 保险类型 (Medicare、Medicaid、Private)
- 合并症评分 (诊断数量、手术数量、用药数量)
- 住院时长 (住院天数、长期住院标志)
- 死亡率风险 (基于诊断和手术的风险评分)
- 其他特征 (种族、婚姻状况等)
```

## 实现细节

### 文件结构
```
datasets/
├── patient_embedding.py    # 新的embedding模块
├── dataset_mimic.py        # 更新的数据集类
└── test_embedding.py       # 测试脚本
```

### 核心类：PatientEmbedding
```python
class PatientEmbedding:
    def __init__(self, drug_vocab, condition_dim=512):
        # 初始化各种编码词汇表
        # 计算各部分的embedding维度
        
    def create_condition_embedding(self, sample):
        # 创建完整的条件embedding
        # 组合诊断、手术、历史用药、患者特征
```

### 维度分配
```
总维度: 512
├── 诊断编码: 64维  (12.5%)
├── 手术编码: 32维  (6.25%)
├── 历史用药: 64维  (12.5%)
└── 患者特征: 352维 (68.75%)
```

## 优势对比

### 原有方案问题
- ❌ ICD编码直接转float，丢失语义
- ❌ 固定长度截断，丢失信息
- ❌ 编码数值无医学意义
- ❌ 患者特征完全未使用

### 改进方案优势
- ✅ 保留ICD编码语义信息
- ✅ 提取有意义的统计特征
- ✅ 避免截断重要信息
- ✅ 充分利用患者特征空间
- ✅ 保持医学语义一致性

## 使用方法

### 1. 测试新embedding
```bash
cd /home/zhuwei/zhangjian/MCTScode/mct_diffusion2/multinomial_diffusion-main/text_diffusion
python test_embedding.py
```

### 2. 重新预处理数据
```bash
# 删除旧的预处理数据
rm -rf datasets/mimic_drugs/processed_*.pt
rm -rf datasets/mimic_drugs/conditions_*.pt

# 重新运行预处理
python preprocess_mimic.py
```

### 3. 训练模型
```bash
python train_mimic.py --dataset mimic_drugs --batch_size 32 --epochs 100
```

## 预期效果

1. **更好的语义表示**：ICD编码的语义信息得到保留
2. **更丰富的信息**：患者特征得到充分利用
3. **更少的截断**：重要信息得到保留
4. **更好的性能**：条件扩散模型能更好地利用病人信息

## 下一步

这个改进的embedding方案为条件扩散模型提供了坚实的基础。接下来可以：

1. 实现条件扩散模型
2. 添加0/1/MASK三值加噪策略
3. 构建基于扩散模型的奖励函数
4. 集成到蒙特卡洛树搜索中
